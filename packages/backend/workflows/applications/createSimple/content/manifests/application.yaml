apiVersion: core.oam.dev/v1beta1
kind: Application
metadata:
  name: ${{ values.name }}
spec:
  components:
    - name: ${{ values.basic.name }}
      type: edgefarm-applications
      properties:
        image: ${{ values.basic.image }}
        nodepoolSelector:
          matchLabels:
            {%- set varArray = values.basic.target.split("=") %}
            ${{ varArray[0] }}: "${{ varArray[1] }}"
        name: ${{ values.basic.name }}
        {% if values.advanced.command -%}
        command:
          {%- for cmd in values.advancedCommand %}
            - ${{ cmd }}
          {%- endfor %}
        {%- endif %}
        {% if values.advanced.args -%}
        args:
          {%- for arg in values.advancedArgs %}
            - ${{ arg }}
          {%- endfor %}
        {%- endif %}
        cpu: ${{ values.advanced.cpu }}
        memory: ${{ values.advanced.memory -}}
        {% if values.advanced.envVars|length > 0 -%}
        env:
          {%- for envVar in values.advanced.envVars %}
          {%- set varArray = envVar.split("=") %}
          - name: ${{ varArray[0] }}
            value: ${{ varArray[1] }}
          {%- endfor %}
        {%- endif %}
      traits:
        {%- if values.enableNetwork %}
        - type: edgefarm-network
          properties:
            network:
              name: ${{ values.networkSettings.network }}
              subnetwork: ${{ values.networkSettings.subnetwork }}
              user: ${{ values.networkSettings.user }}
        {%- endif %}
        {%- if values.advanced.storage.hostPaths|length > 0 %}
        - type: edgefarm-storage
          properties:
            hostPath:
            {%- for hostPath in values.advanced.storage.hostPaths %}
              - name: ${{ hostPath.name }}
            {%- endfor %}
        {%- endif %}
        {% if not values.enableNetwork and not values.advanced.storage.hostPaths|length > 0 -%}
        []
        {% endif %}